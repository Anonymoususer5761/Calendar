{% extends 'layout.html' %}

{% block main %}
    <h1>{{ date }}</h1>
    <button id="add-event-button">Add Event</button>

    <div id="day-timeline-div">
        <svg id="day-timeline-svg" width="1500" height="2800" viewBox="0 0 1500 2600">

            <defs>
                <linearGradient id="day-fill" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="10%" style="stop-color: rgb(236, 236, 236); stop-opacity: 0.1"></stop>
                    <stop offset="35%" style="stop-color: rgb(0, 0, 100); stop-opacity: 0.05"></stop>
                    <stop offset="100%" style="stop-color: rgb(255, 255, 255); stop-opacity: 0.15"></stop>

                </linearGradient>
                <linearGradient id="day-stroke" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="35%" style="stop-color: rgb(12, 25, 100); stop-opacity: 0.65"></stop>
                    <stop offset="100%" style="stop-color: rgb(0, 0, 0); stop-opacity: 0.85"></stop>
                </linearGradient>
            </defs>
            <text x="1250" y="0" dominant-baseline="top" text-anchor="middle" font-size="40" fill="black">
                {{ day_name }}
            </text>

            <polyline class="day" points="1500,100 50,100 50,2500 1500,2500"/>

            <line class="hours" x1="50" y1=100 x2="1475" y2=100></line>
            <line class="hours" x1="50" y1=300 x2="1475" y2=300></line>
            <line class="hours" x1="50" y1=500 x2="1475" y2=500></line>
            <line class="hours" x1="50" y1=700 x2="1475" y2=700></line>
            <line class="hours" x1="50" y1=900 x2="1475" y2=900></line>
            <line class="hours" x1="50" y1=1100 x2="1475" y2=1100></line>
            <line class="hours" x1="50" y1=1300 x2="1475" y2=1300></line>
            <line class="hours" x1="50" y1=1500 x2="1475" y2=1500></line>
            <line class="hours" x1="50" y1=1700 x2="1475" y2=1700></line>
            <line class="hours" x1="50" y1=1900 x2="1475" y2=1900></line>
            <line class="hours" x1="50" y1=2100 x2="1475" y2=2100></line>
            <line class="hours" x1="50" y1=2300 x2="1475" y2=2300></line>
            <line class="hours" x1="50" y1=2500 x2="1475" y2=2500></line>
            <line class="hours" x1="50" y1=2700 x2="1475" y2=2700></line>
            <line class="hours" x1="50" y1=2900 x2="1475" y2=2900></line>
            <line class="hours" x1="50" y1=3100 x2="1475" y2=3100></line>
            <line class="hours" x1="50" y1=3300 x2="1475" y2=3300></line>
            <line class="hours" x1="50" y1=3500 x2="1475" y2=3500></line>
            <line class="hours" x1="50" y1=3700 x2="1475" y2=3700></line>
            <line class="hours" x1="50" y1=3900 x2="1475" y2=3900></line>
            <line class="hours" x1="50" y1=4100 x2="1475" y2=4100></line>
            <line class="hours" x1="50" y1=4300 x2="1475" y2=4300></line>
            <line class="hours" x1="50" y1=4500 x2="1475" y2=4500></line>
            <line class="hours" x1="50" y1=4700 x2="1475" y2=4700></line>
            <line class="hours" x1="50" y1=4900 x2="1475" y2=4900></line>

            <line id="now" x1="50" x2="1475" display="none"/>
        </svg>
    </div>


    <div id="add-event-div">
        <form id="add-event-form" action="", method="post">
            <label class="event-form-data">Event</label>
            <br>
            <input id="event-name" class="event-form-data" name="event-name" autocomplete="off" required placeholder="Event Name">
            <br>

            <label>Description</label>
            <br>
            <textarea id="event-description" class="event-form-date" name="event-description" autocomplete="off" placeholder="Event Description"></textarea>
            <br><br>

            <label class="event-form-data">From</label>
            <input class="event-form-data" class="start" id="event-timings-date-start" class="event-timings-date" name="event-timings-date-start" value="{{ date }}" min="1971-01-01" max="2099-12-31" required type="date"></input>
            <input class="event-form-data" class="start" id="event-timings-time-start" class="event-timings-time" name="event-timings-time-start" value="00:00"  type="time"></input>
            <br><br>

            <label class="event-form-data">To</label>
            <input class="event-form-data" class="end" id="event-timings-date-end" class="event-timings-date" name="event-timings-date-end" value="{{ date }}" min="{{ date }}" max="2099-12-31" required type="date"></input>
            <input class="event-form-data" class="end" id="event-timings-time-end" class="event-timings-time"  name="event-timings-time-end" value="00:00" type="time"></input>
            <br><br>

            <label class="event-form-data">Event Color</label>
            <select id="event-color" class="event-form-data" name="event-color">
                <option value="red">Red</option>
                <option value="green">Green</option>
                <option value="blue">Blue</option>
                <option value="purple">Purple</option>
                <option value="yellow">Yellow</option>
            </select>
            <svg width="30" height="25">
                <rect fill="red" x="15" y="15" width="30" height="12.5"></rect>
            </svg>
            <br>
            
            <input class="event-form-data" value="Add Event" type="submit">
            <button id="event-form-close">Close</button>
        </form>
    </div>

    {% if current_user.is_authenticated %}
        <div id="event-table-div">
            <table id="event-table">
                <thead>
                    <tr class="event-table-row">
                        <th class="event-table-data">Index</th>
                        <th class="event-table-data">Event</th>
                        <th class="event-table-data">Description</th>
                        <th class="event-table-data">Start</th>
                        <th class="event-table-data">End</th>
                        <th class="event-table-data">Color</th>
                    </tr>
                </thead>
                <tbody id="event-table-body">

                </tbody>
            </table>
        </div>
    {% endif %}


    <script>
        let eventTimingsDate = document.getElementsByClassName('event-timings-date');
        let eventTimingsTime = document.getElementsByClassName('event-timings-time');
        let eventTimingsMinutes = document.getElementsByClassName('event-timings-minutes');

        function pad(singleDigit) {
            singleDigit = singleDigit.toString().padStart(2, '0');
            return singleDigit;
        }
    
        function setColorMenuColor() {
            document.querySelector('rect').setAttribute('fill', eventColorMenu.value);
        }

        let eventColorMenu = document.getElementById('event-color');
        document.addEventListener('DOMContentLoaded', setColorMenuColor);
        eventColorMenu.addEventListener('change', setColorMenuColor);

        let startDate = document.getElementById('event-timings-date-start');
        let endDate = document.getElementById('event-timings-date-end');
        let startTime = document.getElementById('event-timings-time-start');
        let endTime = document.getElementById('event-timings-time-end');

        document.addEventListener('DOMContentLoaded', () => {
            endDate.setAttribute('min', startDate.value);
            if (startDate.value === endDate.value) {
                endTime.setAttribute('min', startTime.value);
            }
        });
        startDate.addEventListener('change', () => {
            endDate.setAttribute('min', startDate.value);
            if (startDate.value === endDate.value) {
                endTime.setAttribute('min', startTime.value);
            }
        });
        startTime.addEventListener('change', () => {
            endDate.setAttribute('min', startDate.value);
            if (startDate.value === endDate.value) {
                endTime.setAttribute('min', startTime.value);
            }
        });

        // Below is the JavaScript for the Day Timeline.
        selectedDate = document.querySelector('h1').innerHTML;
        // Used ChatGPT to fix a bug where time wouldn't not update dynamically.
        function moveDayLine() {
            let svg = document.getElementById('now');
            let now = new Date();
            let time = now.getTime() % 864000000 // 86400 times 1000 (seconds into milliseconds) = 86.4M.
            let y_axis = (time / 360000) + 100;
            svg.setAttribute("y1", y_axis);
            svg.setAttribute("y2", y_axis);
            svg.removeAttribute("display");
        }


        if (localStorage.getItem('today').split("T")[0] === selectedDate) {
            document.addEventListener('DOMContentLoaded', moveDayLine())
            let interval = setInterval(moveDayLine, 1000);
        }

        // Events imported from Fetch API.
        let dayId = document.location.href.split('?')[1].split('=')[1];
        async function getEvents() {
            let response = await fetch(`/api/dates/events?date_id=${dayId}`, {
                headers: {
                    'Request-Source': 'JS-AJAX',
                }
            });
            let events = await response.json();
            return events;
        }

        function dispEventsSVG(events) {
            let svg = ``;
            for (let event of events) {
                let start = event["timings_start"];
                let end = event["timings_end"];
                let secondsInDay = 86400;
                let secondsInDayByScaleOfTimeline = 36 // 86400 / 2400 = 36. The difference in pixels between 00:00 and 24:00 is exactly 2400px (2500 - 100). 
                let offset = 100 // The timeline starts at 100px.
                let x1 = 0;
                let x2 = 0;
                if (Math.trunc(start / secondsInDay) + 1 === parseInt(dayId)) {
                    x1 = start % secondsInDay / secondsInDayByScaleOfTimeline + offset;
                } else {
                    x1 = 100;
                }
                if (Math.trunc(end / secondsInDay) + 1 === parseInt(dayId)) {
                    x2 = end % secondsInDay / secondsInDayByScaleOfTimeline + offset;
                } else {
                    x2 = 2499;
                }
                svg += `<polyline class="custom-lines" name="${event["name"]}" points="${x1},30 ${x1},510 ${x2},510 ${x2},30" fill=${event["color"]} stroke=${event["color"]} opacity="0.25"></polyline>`;
            }
            document.querySelector('svg').innerHTML += svg;
        }

        function dispEventsTable(events) {
            html = '';
            let i = 1;
            for (event of events) {
                html += '<tr class=event-table-row>';
                html += `<td class=event-table-data id="event-table-index">${i}</td>`;
                html += `<td class=event-table-data>${event["name"]}</td>`;
                html += `<td class=event-table-data>${event["desc"]}</td>`;
                html += `<td class=event-table-data>${event["timings_start"]}</td>`;
                html += `<td class=event-table-data>${event["timings_end"]}</td>`;
                html += `<td class=event-table-data>${event["color"]}</td>`;
                html += '</tr>';
                i++;
            }
            document.getElementById('event-table-body').innerHTML += html;
        }

        let auth = false;
        auth = localStorage.getItem('auth') === '1';  
        // Used ChatGPT to better understand how promises work and how to work with .then method.
        if (auth) {
            getEvents().then(events => {
                dispEventsTable(events);
                dispEventsSVG(events);
            });
        }


        let addFormButton = document.getElementById('add-event-button');
        addFormButton.addEventListener('click', () => {
            if (auth) {
                document.getElementById('add-event-div').style.display = 'flex';
            } else {
                alert("User not authenticated. You must sign in to acces this feature.")
            }
        });
        let removeFormButton = document.getElementById('event-form-close');
        removeFormButton.addEventListener('click', () => {
            document.getElementById('add-event-div').style.display = 'none';
        })
    </script>
{% endblock main %}